---
import Layout from "../layouts/Layout.astro";
import Navigation from "../components/navigation.astro";
import Welcome from "../components/welcome.astro";
import { supabase } from "../lib/supabase.js";

const accessToken = Astro.cookies.get("sb-access-token")?.value;
const refreshToken = Astro.cookies.get("sb-refresh-token")?.value;
let user = null;

if (accessToken && refreshToken) {
  await supabase.auth.setSession({
    access_token: accessToken,
    refresh_token: refreshToken,
  });

  const { data } = await supabase.auth.getUser();
  user = data?.user ?? null;
}

let notice = "";
let errorMessage = "";
const reactionOptions = ["ðŸ‘", "â¤ï¸", "ðŸ˜‚", "ðŸ˜®", "ðŸŽ‰"];

if (Astro.request.method === "POST") {
  const formData = await Astro.request.formData();
  const action = String(formData.get("action") || "");

  if (action === "comment") {
    if (!user) {
      errorMessage = "Please sign in to comment.";
    } else {
      const postId = Number(formData.get("post_id"));
      const content = String(formData.get("content") || "").trim();

      if (!content) {
        errorMessage = "Comment cannot be empty.";
      } else {
        const { error } = await supabase
          .from("comments")
          .insert([{ post_id: postId, user_id: user.id, content }]);

        if (error) {
          errorMessage = error.message;
        } else {
          notice = "Comment posted.";
        }
      }
    }
  }

  if (action === "reaction") {
    if (!user) {
      errorMessage = "Please sign in to react.";
    } else {
      const commentId = Number(formData.get("comment_id"));
      const emoji = String(formData.get("emoji") || "").trim();

      if (!commentId || !reactionOptions.includes(emoji)) {
        errorMessage = "Invalid reaction.";
      } else {
        const { data: existing } = await supabase
          .from("comment_reactions")
          .select("id")
          .eq("comment_id", commentId)
          .eq("user_id", user.id)
          .eq("emoji", emoji)
          .maybeSingle();

        const { error } = existing
          ? await supabase
              .from("comment_reactions")
              .delete()
              .eq("id", existing.id)
          : await supabase
              .from("comment_reactions")
              .insert([{ comment_id: commentId, user_id: user.id, emoji }]);

        if (error) {
          errorMessage = error.message;
        } else {
          notice = existing ? "Reaction removed." : "Reaction added.";
        }
      }
    }
  }

  if (action === "post_reaction") {
    if (!user) {
      errorMessage = "Please sign in to react.";
    } else {
      const postId = Number(formData.get("post_id"));
      const emoji = String(formData.get("emoji") || "").trim();

      if (!postId || !reactionOptions.includes(emoji)) {
        errorMessage = "Invalid reaction.";
      } else {
        const { data: existing } = await supabase
          .from("post_reactions")
          .select("id")
          .eq("post_id", postId)
          .eq("user_id", user.id)
          .eq("emoji", emoji)
          .maybeSingle();

        const { error } = existing
          ? await supabase
              .from("post_reactions")
              .delete()
              .eq("id", existing.id)
          : await supabase
              .from("post_reactions")
              .insert([{ post_id: postId, user_id: user.id, emoji }]);

        if (error) {
          errorMessage = error.message;
        } else {
          notice = existing ? "Reaction removed." : "Reaction added.";
        }
      }
    }
  }
}

const { data: posts, error } = await supabase
  .from("posts")
  .select("id, title, content, created_at")
  .order("created_at", { ascending: false })
  .limit(5);

const postIds = posts?.map((post) => post.id) ?? [];
const commentsByPost = new Map();
const reactionsByComment = new Map();
const reactionsByPost = new Map();

if (postIds.length > 0) {
  const { data: postReactions } = await supabase
    .from("post_reactions")
    .select("post_id, emoji")
    .in("post_id", postIds);

  if (postReactions) {
    for (const reaction of postReactions) {
      const counts = reactionsByPost.get(reaction.post_id) ?? new Map();
      counts.set(reaction.emoji, (counts.get(reaction.emoji) ?? 0) + 1);
      reactionsByPost.set(reaction.post_id, counts);
    }
  }

  const { data: comments } = await supabase
    .from("comments")
    .select("id, post_id, content, created_at")
    .in("post_id", postIds)
    .order("created_at", { ascending: true });

  if (comments) {
    for (const comment of comments) {
      const list = commentsByPost.get(comment.post_id) ?? [];
      list.push(comment);
      commentsByPost.set(comment.post_id, list);
    }
  }

  const commentIds = comments?.map((comment) => comment.id) ?? [];
  if (commentIds.length > 0) {
    const { data: reactions } = await supabase
      .from("comment_reactions")
      .select("comment_id, emoji")
      .in("comment_id", commentIds);

    if (reactions) {
      for (const reaction of reactions) {
        const counts = reactionsByComment.get(reaction.comment_id) ?? new Map();
        counts.set(reaction.emoji, (counts.get(reaction.emoji) ?? 0) + 1);
        reactionsByComment.set(reaction.comment_id, counts);
      }
    }
  }
}
---

<Layout title="JuanMataku Blog">
  <Navigation />
  <Welcome />

  <section class="panel">
    <h2>Latest 5 posts</h2>

    {notice && <p class="status-banner status-success">{notice}</p>}
    {errorMessage && <p class="status-banner status-error">{errorMessage}</p>}

    {error && <p>Error: {error.message}</p>}

    {posts && posts.length > 0 ? (
      <ul>
        {posts.map((post) => (
          <li>
            <h3>{post.title}</h3>
            <small>{new Date(post.created_at).toLocaleDateString()}</small>
            <p>{post.content}</p>
            <div class="mt-4 flex flex-wrap gap-2">
              {reactionOptions.map((emoji) => {
                const counts = reactionsByPost.get(post.id) ?? new Map();
                const count = counts.get(emoji) ?? 0;
                return user ? (
                  <form method="POST">
                    <input type="hidden" name="action" value="post_reaction" />
                    <input type="hidden" name="post_id" value={post.id} />
                    <button
                      class="flex items-center gap-2 rounded-full border border-gray-300 bg-white/90 px-3 py-1.5 text-sm font-medium text-gray-800 shadow-sm hover:bg-white"
                      type="submit"
                      name="emoji"
                      value={emoji}
                    >
                      <span aria-hidden="true">{emoji}</span>
                      <span class="text-black">{count}</span>
                      <span class="sr-only">React</span>
                    </button>
                  </form>
                ) : (
                  <div class="flex items-center gap-2 rounded-full border border-gray-300 bg-white/90 px-3 py-1.5 text-sm font-medium text-gray-800 shadow-sm">
                    <span aria-hidden="true">{emoji}</span>
                    <span class="text-black">{count}</span>
                  </div>
                );
              })}
            </div>

            <div class="mt-4 space-y-3">
              {(commentsByPost.get(post.id) ?? []).length ? (
                <div class="space-y-2">
                  {(commentsByPost.get(post.id) ?? []).map((comment) => {
                    const counts = reactionsByComment.get(comment.id) ?? new Map();
                    return (
                      <div class="rounded-2xl border-2 border-gray-800 bg-white/90 px-4 py-3 text-sm">
                        <p>{comment.content}</p>
                        <p class="text-xs text-gray-700">
                          {new Date(comment.created_at).toLocaleString()}
                        </p>

                        <div class="mt-2 flex flex-wrap gap-2">
                          {reactionOptions.map((emoji) => {
                            const count = counts.get(emoji) ?? 0;
                            return user ? (
                              <form method="POST">
                                <input type="hidden" name="action" value="reaction" />
                                <input type="hidden" name="comment_id" value={comment.id} />
                                <button
                                  class="flex items-center gap-2 rounded-full border border-gray-300 bg-white/90 px-3 py-1.5 text-sm font-medium text-gray-800 shadow-sm hover:bg-white"
                                  type="submit"
                                  name="emoji"
                                  value={emoji}
                                >
                                  <span aria-hidden="true">{emoji}</span>
                                  <span class="text-black">{count}</span>
                                  <span class="sr-only">React</span>
                                </button>
                              </form>
                            ) : (
                              <div class="flex items-center gap-2 rounded-full border border-gray-300 bg-white/90 px-3 py-1.5 text-sm font-medium text-gray-800 shadow-sm">
                                <span aria-hidden="true">{emoji}</span>
                                <span class="text-black">{count}</span>
                              </div>
                            );
                          })}
                        </div>
                      </div>
                    );
                  })}
                </div>
              ) : (
                <p class="text-sm text-gray-600">No comments yet.</p>
              )}

              {user ? (
                <form method="POST" class="space-y-2">
                  <input type="hidden" name="action" value="comment" />
                  <input type="hidden" name="post_id" value={post.id} />
                  <label class="text-sm font-medium" for={`comment-${post.id}`}>Add a comment</label>
                  <textarea
                    class="mt-1 w-full border rounded-lg px-3 py-2"
                    id={`comment-${post.id}`}
                    name="content"
                    rows="2"
                    required
                  ></textarea>
                  <button class="bg-black text-white rounded-lg px-4 py-2 hover:opacity-90" type="submit">
                    Comment
                  </button>
                </form>
              ) : (
                <p class="text-sm text-gray-600">
                  <a class="inline-link" href="/signin">Sign in</a> to comment.
                </p>
              )}
            </div>
          </li>
        ))}
      </ul>
    ) : (
      <p>No posts yet.</p>
    )}
  </section>
</Layout>
