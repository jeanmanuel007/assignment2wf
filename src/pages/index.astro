---
import Layout from "../layouts/Layout.astro";
import Navigation from "../components/navigation.astro";
import Welcome from "../components/welcome.astro";
import { supabase } from "../lib/supabase.js";

const accessToken = Astro.cookies.get("sb-access-token")?.value;
const refreshToken = Astro.cookies.get("sb-refresh-token")?.value;
let user = null;

if (accessToken && refreshToken) {
  await supabase.auth.setSession({
    access_token: accessToken,
    refresh_token: refreshToken,
  });

  const { data } = await supabase.auth.getUser();
  user = data?.user ?? null;
}

let notice = "";
let errorMessage = "";

if (Astro.request.method === "POST") {
  const formData = await Astro.request.formData();
  const action = String(formData.get("action") || "");

  if (action === "comment") {
    if (!user) {
      errorMessage = "Please sign in to comment.";
    } else {
      const postId = Number(formData.get("post_id"));
      const content = String(formData.get("content") || "").trim();

      if (!content) {
        errorMessage = "Comment cannot be empty.";
      } else {
        const { error } = await supabase
          .from("comments")
          .insert([{ post_id: postId, user_id: user.id, content }]);

        if (error) {
          errorMessage = error.message;
        } else {
          notice = "Comment posted.";
        }
      }
    }
  }
}

const { data: posts, error } = await supabase
  .from("posts")
  .select("id, title, content, created_at")
  .order("created_at", { ascending: false })
  .limit(5);

const postIds = posts?.map((post) => post.id) ?? [];
const commentsByPost = new Map();

if (postIds.length > 0) {
  const { data: comments } = await supabase
    .from("comments")
    .select("id, post_id, content, created_at")
    .in("post_id", postIds)
    .order("created_at", { ascending: true });

  if (comments) {
    for (const comment of comments) {
      const list = commentsByPost.get(comment.post_id) ?? [];
      list.push(comment);
      commentsByPost.set(comment.post_id, list);
    }
  }
}
---

<Layout title="JuanMataku Blog">
  <Navigation />
  <Welcome />

  <section class="panel">
    <h2>Latest 5 posts</h2>

    {notice && <p class="status-banner status-success">{notice}</p>}
    {errorMessage && <p class="status-banner status-error">{errorMessage}</p>}

    {error && <p>Error: {error.message}</p>}

    {posts && posts.length > 0 ? (
      <ul>
        {posts.map((post) => (
          <li>
            <h3>{post.title}</h3>
            <small>{new Date(post.created_at).toLocaleDateString()}</small>
            <p>{post.content}</p>

            <div class="mt-4 space-y-3">
              {(commentsByPost.get(post.id) ?? []).length ? (
                <div class="space-y-2">
                  {(commentsByPost.get(post.id) ?? []).map((comment) => (
                    <div class="rounded-lg border bg-white px-3 py-2 text-sm">
                      <p>{comment.content}</p>
                      <p class="text-xs text-gray-600">
                        {new Date(comment.created_at).toLocaleString()}
                      </p>
                    </div>
                  ))}
                </div>
              ) : (
                <p class="text-sm text-gray-600">No comments yet.</p>
              )}

              {user ? (
                <form method="POST" class="space-y-2">
                  <input type="hidden" name="action" value="comment" />
                  <input type="hidden" name="post_id" value={post.id} />
                  <label class="text-sm font-medium" for={`comment-${post.id}`}>Add a comment</label>
                  <textarea
                    class="mt-1 w-full border rounded-lg px-3 py-2"
                    id={`comment-${post.id}`}
                    name="content"
                    rows="2"
                    required
                  ></textarea>
                  <button class="bg-black text-white rounded-lg px-4 py-2 hover:opacity-90" type="submit">
                    Comment
                  </button>
                </form>
              ) : (
                <p class="text-sm text-gray-600">
                  <a class="inline-link" href="/signin">Sign in</a> to comment.
                </p>
              )}
            </div>
          </li>
        ))}
      </ul>
    ) : (
      <p>No posts yet.</p>
    )}
  </section>
</Layout>
